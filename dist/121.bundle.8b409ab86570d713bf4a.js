"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[121],{23121:(e,t,n)=>{n.r(t),n.d(t,{default:()=>S});var o=n(41766),r=n(11374),s=n.n(r),a=n(5085);const i={NO_NEVER:-1,CANCEL:0,HYDRATE_SEG:5};const l=function({servicesManager:e,rtDisplaySet:t,viewportId:n,toolGroupId:o="default",preHydrateCallbacks:r,hydrateRTDisplaySet:s}){const{uiViewportDialogService:l}=e.services,c=e._extensionManager._appConfig;return new Promise((async function(p,u){const d=c?.disableConfirmationPrompts?i.HYDRATE_SEG:await function(e,t){return new Promise((function(n,o){const r="Do you want to open this Segmentation?",s=[{type:a.Ny.NW.secondary,text:"No",value:i.CANCEL},{type:a.Ny.NW.primary,text:"Yes",value:i.HYDRATE_SEG}],l=t=>{e.hide(),n(t)};e.show({id:"promptHydrateRT",viewportId:t,type:"info",message:r,actions:s,onSubmit:l,onOutsideClick:()=>{e.hide(),n(i.CANCEL)},onKeyPress:e=>{"Enter"===e.key&&l(i.HYDRATE_SEG)}})}))}(l,n);d===i.HYDRATE_SEG&&(r?.forEach((e=>{e()})),window.setTimeout((async()=>{const r=await s({rtDisplaySet:t,viewportId:n,toolGroupId:o,servicesManager:e});p(r)}),0))}))};var c=n(80619);function p({isHydrated:e,onStatusClick:t}){let n=null,r=null;switch(e){case!0:r=()=>o.createElement(a.In,{name:"status-alert"}),n=()=>o.createElement("div",null,"This Segmentation is loaded in the segmentation panel");break;case!1:r=()=>o.createElement(a.In,{className:"text-aqua-pale",name:"status-untracked"}),n=()=>o.createElement("div",null,"Click LOAD to load RTSTRUCT.")}const s=()=>{const{t:n}=(0,c.Bd)("Common"),s=n("LOAD");return o.createElement("div",{className:"flex h-6 cursor-default text-sm leading-6 text-white"},o.createElement("div",{className:"bg-customgray-100 flex min-w-[45px] items-center rounded-l-xl rounded-r p-1"},o.createElement(r,null),o.createElement("span",{className:"ml-1"},"RTSTRUCT")),!e&&o.createElement("div",{className:"bg-primary-main hover:bg-primary-light ml-1 cursor-pointer rounded px-1.5 hover:text-black",onMouseUp:t},s))};return o.createElement(o.Fragment,null,n&&o.createElement(a.m_,{content:o.createElement(n,null),position:"bottom-left"},o.createElement(s,null)),!n&&o.createElement(s,null))}const u=function(e,t,n){const{tools:o}=t.get("cornerstone.overlayViewportTools")??{};return e.createToolGroupAndAddTools(n,o)};function d(){return d=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},d.apply(this,arguments)}function m(e){const{children:t,displaySets:n,viewportOptions:r,servicesManager:s,extensionManager:i,commandsManager:c}=e,{displaySetService:m,toolGroupService:S,segmentationService:y,uiNotificationService:v,customizationService:E,viewportActionCornersService:g}=s.services,w=r.viewportId,f=`RTToolGroup-${w}`;if(n.length>1)throw new Error("RT viewport should only have a single display set");const I=n[0],[T,b]=(0,a.ih)(),[h,C]=(0,o.useState)(!1),[D,N]=(0,o.useState)(1),[A,k]=(0,o.useState)(I.isHydrated),[O,R]=(0,o.useState)(!I.isLoaded),[P,x]=(0,o.useState)(null),[G,M]=(0,o.useState)({percentComplete:null,totalSegments:null}),L=(0,o.useRef)(null),{viewports:_,activeViewportId:U}=T,H=I.getReferenceDisplaySet(),V=function(e){const t=e.images[0],n={PatientID:t.PatientID,PatientName:t.PatientName,PatientSex:t.PatientSex,PatientAge:t.PatientAge,SliceThickness:t.SliceThickness,StudyDate:t.StudyDate,SeriesDescription:t.SeriesDescription,SeriesInstanceUID:t.SeriesInstanceUID,SeriesNumber:t.SeriesNumber,ManufacturerModelName:t.ManufacturerModelName,SpacingBetweenSlices:t.SpacingBetweenSlices};return n}(H);L.current={displaySet:H,metadata:V};const j=()=>{x(null)},Y=(0,o.useCallback)((()=>{T?.viewports.forEach((({viewportId:e})=>{c.runCommand("storePresentation",{viewportId:e})}))}),[T]),F=({rtDisplaySet:e,viewportId:t})=>{c.runCommand("loadSegmentationDisplaySetsForViewport",{displaySets:[e],viewportId:t})},B=(0,o.useCallback)((()=>{const{component:t}=i.getModuleEntry("@ohif/extension-cornerstone.viewportModule.cornerstone"),{displaySet:n}=L.current;return o.createElement(t,d({},e,{displaySets:[n,I],viewportOptions:{viewportType:"volume",toolGroupId:f,orientation:r.orientation,viewportId:r.viewportId},onElementEnabled:t=>{e.onElementEnabled?.(t),(e=>{x(e.detail.element)})(t)},onElementDisabled:j}))}),[w,I,f]),q=(0,o.useCallback)((e=>{const t=I.displaySetInstanceUID,n=y.getSegmentation(t),{segments:o}=n,r=Object.keys(o).length;let s=D+e;s>=r-1?s=1:0===s&&(s=r-1),y.jumpToSegmentCenter(t,s,f),N(s)}),[D]);(0,o.useEffect)((()=>{O||l({servicesManager:s,viewportId:w,rtDisplaySet:I,preHydrateCallbacks:[Y],hydrateRTDisplaySet:F}).then((e=>{e&&k(!0)}))}),[s,w,I,O]),(0,o.useEffect)((()=>{const{unsubscribe:e}=y.subscribe(y.EVENTS.SEGMENTATION_LOADING_COMPLETE,(e=>{e.rtDisplaySet.displaySetInstanceUID===I.displaySetInstanceUID&&R(!1),e.overlappingSegments&&v.show({title:"Overlapping Segments",message:"Overlapping segments detected which is not currently supported",type:"warning"})}));return()=>{e()}}),[I]),(0,o.useEffect)((()=>{const{unsubscribe:e}=y.subscribe(y.EVENTS.SEGMENT_LOADING_COMPLETE,(({percentComplete:e,numSegments:t})=>{M({percentComplete:e,totalSegments:t})}));return()=>{e()}}),[I]),(0,o.useEffect)((()=>{const e=m.subscribe(m.EVENTS.DISPLAY_SETS_REMOVED,(({displaySetInstanceUIDs:e})=>{const t=_.get(U);e.includes(t.displaySetInstanceUID)&&b.setDisplaySetsForViewport({viewportId:U,displaySetInstanceUIDs:[]})}));return()=>{e.unsubscribe()}}),[]),(0,o.useEffect)((()=>{let e=S.getToolGroup(f);if(!e)return e=u(S,E,f),C(!0),()=>{y.removeSegmentationRepresentationFromToolGroup(f),S.destroyToolGroup(f)}}),[]),(0,o.useEffect)((()=>(k(I.isHydrated),()=>{y.removeSegmentationRepresentationFromToolGroup(f),L.current=null})),[I]);let W=null;if(!L.current||H.displaySetInstanceUID!==L.current.displaySet.displaySetInstanceUID)return null;t&&t.length&&(W=t.map(((e,t)=>e&&o.cloneElement(e,{viewportId:w,key:t}))));const $=(0,o.useCallback)((async()=>{Y();const e=await F({rtDisplaySet:I,viewportId:w});k(e)}),[F,I,Y,w]);return(0,o.useEffect)((()=>{g.setComponents([{viewportId:w,id:"viewportStatusComponent",component:p({isHydrated:A,onStatusClick:$}),indexPriority:-100,location:g.LOCATIONS.topLeft},{viewportId:w,id:"viewportActionArrowsComponent",component:o.createElement(a.$I,{key:"actionArrows",onArrowsClick:q,className:w===U?"visible":"invisible group-hover:visible"}),indexPriority:0,location:g.LOCATIONS.topRight}])}),[U,A,q,$,g,w]),o.createElement(o.Fragment,null,o.createElement("div",{className:"relative flex h-full w-full flex-row overflow-hidden"},O&&o.createElement(a.pT,{className:"h-full w-full",totalNumbers:G.totalSegments,percentComplete:G.percentComplete,loadingText:"Loading RTSTRUCT..."}),B(),W))}m.propTypes={displaySets:s().arrayOf(s().object),viewportId:s().string.isRequired,dataSource:s().object,children:s().node,customProps:s().object},m.defaultProps={customProps:{}};const S=m}}]);
//# sourceMappingURL=121.bundle.8b409ab86570d713bf4a.js.map